<!doctype html><html lang=en-us><head><title>Web applications with automatic TLS certificates and GitHub OAuth2 // Ramblings about all things technical</title><link rel="shortcut icon" href=https://jamesclonk.io/favicon.ico><meta charset=utf-8><meta name=generator content="Hugo 0.109.0"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content="Fabio Berchtold"><meta name=description content="How to setup a Kubernetes Ingress with automatic TLS certificates from Let's Encrypt and GitHub authentication via oauth2-proxy"><link rel=stylesheet href=https://blog.jamesclonk.io/css/main.min.69f3560017b43a1fc9233086d35c5c1844537f85db3f349ed92009e395fa1b93.css><meta name=twitter:card content="summary"><meta name=twitter:title content="Web applications with automatic TLS certificates and GitHub OAuth2"><meta name=twitter:description content="How to setup a Kubernetes Ingress with automatic TLS certificates from Let's Encrypt and GitHub authentication via oauth2-proxy"><meta property="og:title" content="Web applications with automatic TLS certificates and GitHub OAuth2"><meta property="og:description" content="How to setup a Kubernetes Ingress with automatic TLS certificates from Let's Encrypt and GitHub authentication via oauth2-proxy"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.jamesclonk.io/posts/kubernetes-ingress-with-oauth2-proxy/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-01-11T19:22:49+02:00"><meta property="article:modified_time" content="2022-01-11T19:22:49+02:00"></head><body><header class=app-header><a href=https://blog.jamesclonk.io/><img class=app-header-avatar src=/images/fabio_berchtold.jpg alt="Fabio Berchtold"></a><h1>Ramblings about all things technical</h1><nav class=app-header-menu><a class=app-header-menu-item href=/>Home</a>
-
<a class=app-header-menu-item href=/tags/>Tags</a>
-
<a class=app-header-menu-item href=/about/>About</a></nav><p>Working with tech is fun!</p><div class=app-header-social><a href=https://github.com/JamesClonk target=_blank rel="noreferrer noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github"><title>GitHub</title><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></div></header><main class=app-container><article class=post><header class=post-header><h1 class=post-title>Web applications with automatic TLS certificates and GitHub OAuth2</h1><div class=post-meta><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-user"><title>user</title><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>Fabio Berchtold</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar"><title>calendar</title><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>Jan 11, 2022</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock"><title>clock</title><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>9 min read</div><div><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag"><title>tag</title><path d="M20.59 13.41l-7.17 7.17a2 2 0 01-2.83.0L2 12V2h10l8.59 8.59a2 2 0 010 2.82z"/><line x1="7" y1="7" x2="7.01" y2="7"/></svg><a class=tag href=/tags/kubernetes/>kubernetes</a>
<a class=tag href=/tags/ingress/>ingress</a>
<a class=tag href=/tags/oauth2-proxy/>oauth2-proxy</a>
<a class=tag href=/tags/github/>github</a>
<a class=tag href=/tags/cert-manager/>cert-manager</a>
<a class=tag href=/tags/lets-encrypt/>lets-encrypt</a></div></div></header><div class=post-content><blockquote><p><em>&ldquo;Web applications with TLS and OAuth2 on Kubernetes?</em>
<em>Surely you&rsquo;re joking, Mr. JamesClonk!&rdquo;</em></p></blockquote><p>I&rsquo;ve been ranting a lot recently about how inferior Kubernetes is compared to Cloud Foundry. There isn&rsquo;t any redeeming factor, not a single thing it does even remotely as well as CF when it comes to the developer experience in terms of running web applications. Its inherent complexity requires an insane amount of DevOps / operations overhead by comparison.</p><p>Kubernetes is a great tool from an Infrastructure-as-a-Service perspective. No vendor lock-in, platform agnostic, a standardized framework for building on top of any infrastructure, etc.. This is all great, but the misconception a lot of people seem to have (especially the more removed they are from any day-to-day engineering work) is that it is also a Platform-as-a-Service by itself, and that&rsquo;s the area it falls completely flat. There&rsquo;s just zero batteries included in a vanilla K8s installation.</p><p>But now that the world has converged on using Kubernetes, what can we do to at least alleviate the most obvious and painful points with using it for running web apps?</p><p>We will install an ingress controller, a certificate manager and an oauth proxy. ðŸ˜€</p><h2 id=ingress-controller>Ingress Controller</h2><p>What is an <a href=https://kubernetes.io/docs/concepts/services-networking/ingress-controllers/>ingress controller</a>?</p><p>An ingress controller is an extra component that&rsquo;s necessary to be installed on your Kubernetes cluster if you want to make use of Ingress resources. Ingress controllers are not part of Kubernetes itself, and there&rsquo;s many different ones available, for example NGINX, HAProxy, Contour, Traefik, Gloo, etc..
The most common one probably being <a href=https://kubernetes.github.io/ingress-nginx/>ingress-nginx</a>, which uses NGINX internally for handling traffic and routing.</p><p>The <a href=https://kubernetes.io/docs/concepts/services-networking/ingress/>Ingress resource</a> then enables us to expose HTTP and HTTPS routes from outside the cluster to services within the cluster. Traffic routing is controlled by rules defined on such Ingress resources.</p><p>Installation of ingress-nginx is rather easy and straightforward. You can either use the provided <a href=https://github.com/kubernetes/ingress-nginx/tree/main/charts/ingress-nginx>Helm chart</a>, or just directly apply the standalone deployment manifest:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.3.0/deploy/static/provider/cloud/deploy.yaml
</span></span></code></pre></div><p>That&rsquo;s it, it doesn&rsquo;t really require any customization or configuration by default. We&rsquo;ve got our first ingress-controller up and running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n ingress-nginx get all
</span></span><span style=display:flex><span>NAME                                READY   STATUS      RESTARTS   AGE
</span></span><span style=display:flex><span>pod/ingress-nginx-7de24cbef-sdv9q   1/1     Running     <span style=color:#0000cf;font-weight:700>1</span>          234d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                    TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#ce5c00;font-weight:700>(</span>S<span style=color:#ce5c00;font-weight:700>)</span>                      AGE
</span></span><span style=display:flex><span>service/ingress-nginx   NodePort    10.43.134.29    &lt;none&gt;        80:31370/TCP,443:31422/TCP   423d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                            READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>deployment.apps/ingress-nginx   1/1     <span style=color:#0000cf;font-weight:700>1</span>            <span style=color:#0000cf;font-weight:700>1</span>           423d
</span></span></code></pre></div><blockquote><p><strong>Note</strong>: A keen observer might have realized something odd about the output above. Why is it a NodePort and not a LoadBalancer (or ClusterIP). Well, I actually <em>did</em> do some customization for my installation, I&rsquo;ve configured it to a) use HostPorts for the Pods, and b) be exposed via NodePorts externally too. I&rsquo;m running that controller on a single-node cluster and explicitly do not want to use a cloud-provider LoadBalancer, so this makes sense there.</p></blockquote><h2 id=cert-manager>Cert-Manager</h2><p>Next step: <a href=https://cert-manager.io/>cert-manager.io</a></p><p>Yet another controller we&rsquo;ll need to install, but quite a useful one though. Cert-Manager will handle all TLS certificate madness and automation for you, and allow you to use free <a href=https://letsencrypt.org/>Let&rsquo;s Encrypt</a> certificates for using HTTPS with all web applications you have running on your cluster. It will automatically obtain certificates from Let&rsquo;s Encrypt and ensure these are valid, up-to-date and will renew them before they expire.</p><p>Same thing as before, installation is simple and straightforward and doesn&rsquo;t require any customization. Just apply the standalone deployment manifest again:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.9.1/cert-manager.yaml
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n cert-manager get all
</span></span><span style=display:flex><span>NAME                                           READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>pod/cert-manager-webhook-f88ccb77f-xctfm       1/1     Running   <span style=color:#0000cf;font-weight:700>1</span>          234d
</span></span><span style=display:flex><span>pod/cert-manager-6f6bd879b7-npbtc              1/1     Running   <span style=color:#0000cf;font-weight:700>1</span>          234d
</span></span><span style=display:flex><span>pod/cert-manager-cainjector-55b4759d9c-znz6m   1/1     Running   <span style=color:#0000cf;font-weight:700>1</span>          234d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                           TYPE        CLUSTER-IP     EXTERNAL-IP   PORT<span style=color:#ce5c00;font-weight:700>(</span>S<span style=color:#ce5c00;font-weight:700>)</span>    AGE
</span></span><span style=display:flex><span>service/cert-manager           ClusterIP   10.43.44.0     &lt;none&gt;        9402/TCP   617d
</span></span><span style=display:flex><span>service/cert-manager-webhook   ClusterIP   10.43.254.39   &lt;none&gt;        443/TCP    617d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                                      READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>deployment.apps/cert-manager-webhook      1/1     <span style=color:#0000cf;font-weight:700>1</span>            <span style=color:#0000cf;font-weight:700>1</span>           617d
</span></span><span style=display:flex><span>deployment.apps/cert-manager              1/1     <span style=color:#0000cf;font-weight:700>1</span>            <span style=color:#0000cf;font-weight:700>1</span>           617d
</span></span><span style=display:flex><span>deployment.apps/cert-manager-cainjector   1/1     <span style=color:#0000cf;font-weight:700>1</span>            <span style=color:#0000cf;font-weight:700>1</span>           617d
</span></span></code></pre></div><p>What we now need to do though as a second step is to create a <a href=https://cert-manager.io/docs/configuration/acme/#creating-a-basic-acme-issuer>ClusterIssuer</a> for using Let&rsquo;s Encrypt via ACME.
But again, this is pretty straightforward and all that&rsquo;s needed is this:</p><h4 id=cluster-issueryml>cluster-issuer.yml</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cert-manager.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ClusterIssuer</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lets-encrypt</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>cert-manager</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>acme</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># use Let&#39;s Encrypt</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>server</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>https://acme-v02.api.letsencrypt.org/directory</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>email</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>my-email@my-domain.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>privateKeySecretRef</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>lets-encrypt</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>solvers</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># use a http01 solver with our ingress-nginx (https://cert-manager.io/docs/configuration/acme/http01/)</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#204a87;font-weight:700>http01</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>ingress</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>class</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nginx</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Once we&rsquo;ve applied that yaml file the ClusterIssuer is ready to be used.</p><h2 id=github-oauth2>GitHub OAuth2</h2><p>All of the above so far enables us to expose our web applications via HTTPS routes to the internet. <em>&ldquo;But what about security? I don&rsquo;t want my admin dashboard to be available to anyone!&rdquo;</em></p><p>No worries, that&rsquo;s where we&rsquo;re going to setup OAuth2 authentication and authorization for accessing those web applications. The benefit for you of doing this on the Kubernetes cluster&rsquo;s ingress routing layer is that you do not need to write any specific code in your applications for dealing with logins or authentication of any kind. It&rsquo;s completely transparent to the web app itself.</p><p>The most commonly used standard for this procedure in web applications is to use <a href=https://oauth.net/2/>OAuth2</a> with an external provider. Since we are nerdy developers of course we are going to be using GitHub as our OAuth2 provider. ðŸ¤“</p><p>We need to create and setup a GitHub OAuth2 application for that, but this is again pretty straightforward and well documented here: <a href=https://docs.github.com/en/developers/apps/building-oauth-apps/creating-an-oauth-app>https://docs.github.com/en/developers/apps/building-oauth-apps/creating-an-oauth-app</a></p><p>Just follow that guide, fill our out some values and click some buttons. The important thing is that we anticipate what our OAuth2 callback URL is going to look like. We&rsquo;ll deploy <em>oauth2-proxy</em> further down and will register it with an Ingress on the route <code>oauth2-proxy.my-domain.com</code>, thus the callback URL is expected to be <code>https://oauth2-proxy.my-domain.com/oauth2/callback</code></p><p><img src=/images/oauth2_github_new_app.png alt="GitHub OAuth2 Application"></p><p>Don&rsquo;t forget to create a new set of credentials that we&rsquo;ll use in oauth2-proxy. Write down the Client ID and Client secret, we need those in the next step.</p><p><img src=/images/oauth2_github_new_client.png alt="GitHub OAuth2 Client"></p><h2 id=oauth2-proxy>oauth2-proxy</h2><p>Now that we&rsquo;ve created a GitHub OAuth2 application we need something that&rsquo;s able to talk to it and do the whole mystical OAuth dance. This is where <a href=https://oauth2-proxy.github.io/oauth2-proxy/>oauth2-proxy</a> comes into play.</p><p>oauth2-proxy is a simple reverse proxy that provides authentication using various OAuth2 providers such as Google, GitHub, GitLab, and many others.
Together with NGINX we can have it running on Kubernetes and configured to be in front / in the path of traffic to any other web application we want, granting access to them through OAuth2 authentication.</p><p>Since we&rsquo;ve previously created a GitHub OAuth2 application, we are going to configure oauth2-proxy to use that one. The GitHub specific documentation can be found here: <a href=https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/oauth_provider#github-auth-provider>https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/oauth_provider#github-auth-provider</a></p><p>For a quick deployment we&rsquo;re going to use this <a href=https://github.com/oauth2-proxy/manifests>Helm chart</a> as our basis.</p><p>There&rsquo;s two important things we need to properly configure. These are the Secret, containing our GitHub OAuth2 application Client ID and Client Secret, and the ConfigMap, containing the the GitHub provider configuration for oauth2-proxy, for example like this:</p><h4 id=oauth2-proxy-configurationyml>oauth2-proxy-configuration.yml</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oauth2-proxy-secrets</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oauth2-proxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>type</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Opaque</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>stringData</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># read https://oauth2-proxy.github.io/oauth2-proxy/docs/configuration/overview#generating-a-cookie-secret</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>cookie-secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;my-cookie-secret&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#8f5902;font-style:italic># these should be the values from our previous GitHub OAuth2 app we&#39;ve created</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>client-secret</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;my-github-oauth2-app-client-secret&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>client-id</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>&lt;my-github-oauth2-app-client-id&gt;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>ConfigMap</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oauth2-proxy-config</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oauth2-proxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>data</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>oauth2_proxy.cfg</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|-</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    reverse_proxy = &#34;false&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    redirect_url = &#34;https://oauth2-proxy.my-domain.com/oauth2/callback&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    upstreams = &#34;file:///dev/null&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    email_domains = &#34;my-domain.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    provider = &#34;github&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    github_org = &#34;my-github-org&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    github_users = &#34;MyGitHubUsername&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    whitelist_domains=&#34;.my-domain.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    cookie_domains = &#34;.my-domain.com&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    cookie_expire = &#34;168h&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    cookie_secure = &#34;true&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    cookie_httponly = &#34;true&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    cookie_samesite = &#34;lax&#34;
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>    skip_provider_button=&#34;false&#34;</span><span style=color:#f8f8f8;text-decoration:underline>    
</span></span></span></code></pre></div><p>After deploying it we should have oauth2-proxy up and running:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n oauth2-proxy get all
</span></span><span style=display:flex><span>NAME                               READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>pod/oauth2-proxy-5cd58b4dd-8bn2m   1/1     Running   <span style=color:#0000cf;font-weight:700>1</span>          287d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                   TYPE        CLUSTER-IP   EXTERNAL-IP   PORT<span style=color:#ce5c00;font-weight:700>(</span>S<span style=color:#ce5c00;font-weight:700>)</span>              AGE
</span></span><span style=display:flex><span>service/oauth2-proxy   ClusterIP   10.43.48.9   &lt;none&gt;        4180/TCP,44180/TCP   287d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                           READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>deployment.apps/oauth2-proxy   1/1     <span style=color:#0000cf;font-weight:700>1</span>            <span style=color:#0000cf;font-weight:700>1</span>           287d
</span></span></code></pre></div><p>Finally, we also need to create an Ingress resource so that oauth2-proxy can be accessed on our domain/hostname:</p><h4 id=oauth2-proxy-ingressyml>oauth2-proxy-ingress.yml</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Ingress</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oauth2-proxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oauth2-proxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># enforce TLS/HTTPS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nginx.ingress.kubernetes.io/ssl-redirect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nginx.ingress.kubernetes.io/force-ssl-redirect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nginx.ingress.kubernetes.io/server-snippet</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000;font-weight:700>|</span><span style=color:#8f5902;font-style:italic>
</span></span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>      </span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#000>large_client_header_buffers 4 32k;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># instruct ingress-nginx and cert-manager to use the clusterissuer we&#39;ve created earlier for TLS certificates</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cert-manager.io/cluster-issuer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;lets-encrypt&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ingressClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nginx</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>tls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>secretName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oauth2-proxy-ingress-tls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>oauth2-proxy.my-domain.com</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># what certificate should cert-manager request from Let&#39;s Encrypt</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oauth2-proxy.my-domain.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>http</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>paths</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>pathType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Prefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>backend</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>oauth2-proxy</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>4180</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>See the section below about <a href=#ingress-annotations>Ingress annotations</a> to fully understand what&rsquo;s going on here. There&rsquo;s a lot of magic involved behind the scenes by using an Ingress with these special annotations.</p><p>Once the Ingress has been created though and cert-manager has issued a Let&rsquo;s Encrypt certificate for <code>oauth2-proxy.my-domain.com</code>, we can check if it&rsquo;s available and responding properly:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl https://oauth2-proxy.my-domain.com/ping
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ curl https://oauth2-proxy.my-domain.com/ping -I
</span></span><span style=display:flex><span>HTTP/2 <span style=color:#0000cf;font-weight:700>200</span>
</span></span></code></pre></div><h2 id=ingress-annotations>Ingress annotations</h2><p>Now that we have cert-manager and oauth2-proxy up and running it&rsquo;s time to create a &ldquo;route&rdquo; for accessing an actual web app we want to expose and have authentication for. Let&rsquo;s pick Grafana for example.
On my example K8s cluster I already have it running in the <code>grafana</code> namespace:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ kubectl -n grafana get all
</span></span><span style=display:flex><span>NAME                          READY   STATUS    RESTARTS   AGE
</span></span><span style=display:flex><span>pod/grafana-d546f875b-8whml   1/1     Running   <span style=color:#0000cf;font-weight:700>4</span>          471d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME              TYPE        CLUSTER-IP      EXTERNAL-IP   PORT<span style=color:#ce5c00;font-weight:700>(</span>S<span style=color:#ce5c00;font-weight:700>)</span>   AGE
</span></span><span style=display:flex><span>service/grafana   ClusterIP   10.43.220.120   &lt;none&gt;        80/TCP    617d
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>NAME                      READY   UP-TO-DATE   AVAILABLE   AGE
</span></span><span style=display:flex><span>deployment.apps/grafana   1/1     <span style=color:#0000cf;font-weight:700>1</span>            <span style=color:#0000cf;font-weight:700>1</span>           617d
</span></span></code></pre></div><p>In order to expose this Grafana instance publicly we have to create an Ingress resource. This resource is what&rsquo;s going to instruct the ingress-nginx controller to route all traffic for a specific domain/hostname to the Grafana service in the cluster. Let&rsquo;s use <code>grafana.my-domain.com</code> as an example.</p><p>Apart from all the obvious spec configuration as described by the Kubernetes <a href=https://kubernetes.io/docs/concepts/services-networking/ingress/>Ingress documentation</a>, we also have to specifically set a few special annotations on this Ingress resource, instructing the ingress-nginx controller to require authentication for all traffic related to that Ingress.
These are <a href=https://kubernetes.github.io/ingress-nginx/examples/auth/oauth-external-auth/><em>nginx.ingress.kubernetes.io/auth-signin</em></a> and <a href=https://kubernetes.github.io/ingress-nginx/examples/auth/oauth-external-auth/><em>nginx.ingress.kubernetes.io/auth-url</em></a>, pointing them to the oauth2-proxy.</p><p>We also set <a href=https://cert-manager.io/docs/usage/ingress/><em>cert-manager.io/cluster-issuer</em></a> to the ClusterIssuer we&rsquo;ve created previously. Cert-Manager will automatically handle certificate creation and TLS secret management for all Ingress resources with this annotation.</p><h4 id=grafana-ingressyml>grafana-ingress.yml</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#000>---</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>apiVersion</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>networking.k8s.io/v1</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>kind</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Ingress</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>metadata</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grafana</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>namespace</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grafana</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>annotations</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># enforce TLS/HTTPS</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nginx.ingress.kubernetes.io/ssl-redirect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nginx.ingress.kubernetes.io/force-ssl-redirect</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># instruct ingress-nginx to use oauth2-proxy for traffic authentication/authorization</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nginx.ingress.kubernetes.io/auth-signin</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;https://oauth2-proxy.my-domain.com/oauth2/start&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>nginx.ingress.kubernetes.io/auth-url</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;https://oauth2-proxy.my-domain.com/oauth2/auth&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#8f5902;font-style:italic># instruct ingress-nginx and cert-manager to use the clusterissuer we&#39;ve created earlier for TLS certificates</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>cert-manager.io/cluster-issuer</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#4e9a06>&#34;lets-encrypt&#34;</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline></span><span style=color:#204a87;font-weight:700>spec</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>ingressClassName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>nginx</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>tls</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>secretName</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grafana-ingress-tls</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>hosts</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span>- <span style=color:#000>grafana.my-domain.com</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#8f5902;font-style:italic># what certificate should cert-manager request from Let&#39;s Encrypt</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span><span style=color:#204a87;font-weight:700>rules</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>  </span>- <span style=color:#204a87;font-weight:700>host</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grafana.my-domain.com</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>    </span><span style=color:#204a87;font-weight:700>http</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span><span style=color:#204a87;font-weight:700>paths</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>      </span>- <span style=color:#204a87;font-weight:700>path</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>/</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>pathType</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>Prefix</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>        </span><span style=color:#204a87;font-weight:700>backend</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>          </span><span style=color:#204a87;font-weight:700>service</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>name</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#000>grafana</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>            </span><span style=color:#204a87;font-weight:700>port</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span><span style=display:flex><span><span style=color:#f8f8f8;text-decoration:underline>              </span><span style=color:#204a87;font-weight:700>number</span><span style=color:#000;font-weight:700>:</span><span style=color:#f8f8f8;text-decoration:underline> </span><span style=color:#0000cf;font-weight:700>80</span><span style=color:#f8f8f8;text-decoration:underline>
</span></span></span></code></pre></div><p>Once the <code>grafana-ingress.yml</code> has been applied to Kubernetes, cert-manager should have automatically requested and created a valid Let&rsquo;s Encrypt certificate for our domain, <code>grafana.my-domain.com</code> in this example.</p><p>You should now be able to reach Grafana by opening the browser and going to <code>https://grafana.my-domain.com</code>.
When doing so, you&rsquo;ll be greeted automatically by a login page from GitHub, since any traffic going to <code>grafana.my-domain.com</code> first has to pass the authentication process provided by the previously deployed oauth2-proxy:</p><p><img src=/images/oauth2_github_login.png alt="GitHub OAuth2 Login"></p><p>And there we go, after a successful login via GitHub account you can now access and see your Grafana dashboards:</p><p><img src=/images/oauth2_grafana.png alt=Grafana></p></div><div class=post-footer></div></article></main></body></html>